<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ RAG System Performance Test</h1>
        <p>Test the improved RAG system with semantic embeddings and optimized vector search.</p>
    </div>

    <div class="container">
        <h2>Test Documents</h2>
        <button onclick="loadTestDocuments()">Load Test Documents</button>
        <button onclick="clearDocuments()">Clear All Documents</button>
        <div id="docStatus" class="test-results"></div>
    </div>

    <div class="container">
        <h2>Query Test</h2>
        <textarea id="queryInput" rows="3" placeholder="Enter your query...">What is machine learning?</textarea>
        <br><br>
        <button onclick="testQuery()">Test Semantic Search</button>
        <button onclick="compareSearchMethods()">Compare Old vs New</button>
        <div id="queryResults" class="test-results"></div>
    </div>

    <div class="container">
        <h2>Performance Metrics</h2>
        <button onclick="runPerformanceTests()">Run Performance Suite</button>
        <div id="perfResults" class="test-results"></div>
    </div>

    <script type="module">
        import dbService from './src/lib/database/db-service.js';
        import ragService from './src/lib/embeddings/rag-service.js';
        import embeddingService from './src/lib/embeddings/transformers-embedding-service.js';

        window.loadTestDocuments = async function() {
            const status = document.getElementById('docStatus');
            status.innerHTML = '<span class="info">Loading test documents...</span>';

            const testDocs = [
                {
                    title: "Introduction to Machine Learning",
                    content: "Machine learning is a subset of artificial intelligence that enables computers to learn from data without being explicitly programmed. It involves algorithms that can identify patterns, make decisions, and improve their performance over time. Common applications include image recognition, natural language processing, and recommendation systems."
                },
                {
                    title: "Neural Networks Explained",
                    content: "Neural networks are computational models inspired by the human brain. They consist of interconnected nodes (neurons) organized in layers. Information flows from input layer through hidden layers to output layer. Deep learning uses neural networks with many hidden layers to solve complex problems."
                },
                {
                    title: "Natural Language Processing",
                    content: "Natural language processing (NLP) enables computers to understand, interpret, and generate human language. Key techniques include tokenization, embeddings, attention mechanisms, and transformers. Modern NLP powers chatbots, translation services, and text analysis tools."
                },
                {
                    title: "Computer Vision Fundamentals",
                    content: "Computer vision teaches machines to interpret visual information from images and videos. Core concepts include edge detection, feature extraction, object detection, and image segmentation. Applications range from facial recognition to autonomous vehicles."
                },
                {
                    title: "Reinforcement Learning",
                    content: "Reinforcement learning trains agents to make decisions by rewarding desired behaviors. The agent learns through trial and error, optimizing actions to maximize cumulative rewards. It's used in game playing, robotics, and resource optimization."
                }
            ];

            try {
                await dbService.initialize();

                let loaded = 0;
                for (const doc of testDocs) {
                    await ragService.addDocument({
                        content: doc.content,
                        metadata: { title: doc.title, type: 'test' }
                    });
                    loaded++;
                    status.innerHTML = `<span class="info">Loading documents... ${loaded}/${testDocs.length}</span>`;
                }

                const stats = await dbService.getStorageStats();
                status.innerHTML = `
<span class="success">‚úÖ Loaded ${testDocs.length} test documents</span>
<span class="info">Total documents: ${stats.documents || 0}</span>
<span class="info">Total embeddings: ${stats.embeddings || 0}</span>`;
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                console.error(error);
            }
        };

        window.clearDocuments = async function() {
            const status = document.getElementById('docStatus');
            status.innerHTML = '<span class="info">Clearing documents...</span>';

            try {
                const docs = await dbService.searchDocuments({ type: 'test' });
                for (const doc of docs) {
                    await dbService.deleteDocument(doc._id);
                }
                status.innerHTML = '<span class="success">‚úÖ All test documents cleared</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.testQuery = async function() {
            const query = document.getElementById('queryInput').value;
            const results = document.getElementById('queryResults');
            results.innerHTML = '<span class="info">Searching...</span>';

            try {
                const startTime = performance.now();

                // Test semantic search
                const searchResults = await ragService.search(query, { limit: 3 });

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                if (searchResults.length === 0) {
                    results.innerHTML = '<span class="error">No results found</span>';
                    return;
                }

                let output = `<span class="success">‚úÖ Search completed in ${duration}ms</span>\n\n`;
                output += '<span class="info">Top Results:</span>\n';

                searchResults.forEach((result, idx) => {
                    output += `\n${idx + 1}. Score: ${result.score.toFixed(4)}\n`;
                    output += `   Document: ${result.documentId}\n`;
                    output += `   Text: ${result.text.substring(0, 150)}...\n`;
                });

                results.innerHTML = output;
            } catch (error) {
                results.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                console.error(error);
            }
        };

        window.compareSearchMethods = async function() {
            const query = document.getElementById('queryInput').value;
            const results = document.getElementById('queryResults');
            results.innerHTML = '<span class="info">Comparing search methods...</span>';

            try {
                // Generate query embedding
                const queryEmbedding = await embeddingService.generateEmbedding(query);

                // Test new optimized search
                const start1 = performance.now();
                const optimizedResults = await dbService.vectorSearch(queryEmbedding, { limit: 3 });
                const time1 = performance.now() - start1;

                // For comparison, we'll simulate the old brute-force approach
                const start2 = performance.now();
                const db = dbService.getDb('embeddings');
                const allDocs = await db.allDocs({ include_docs: true });
                const embeddings = allDocs.rows.map(row => row.doc);

                // Simulate old cosine similarity calculation
                const bruteForceResults = embeddings
                    .map(emb => ({
                        ...emb,
                        score: dbService.cosineSimilarity(queryEmbedding, emb.vector)
                    }))
                    .filter(emb => emb.score >= 0.7)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);
                const time2 = performance.now() - start2;

                let output = '<span class="success">‚úÖ Comparison Complete</span>\n\n';
                output += `<span class="info">Optimized Vector Index:</span>\n`;
                output += `  Time: ${time1.toFixed(2)}ms\n`;
                output += `  Results: ${optimizedResults.length}\n\n`;

                output += `<span class="info">Brute Force Search:</span>\n`;
                output += `  Time: ${time2.toFixed(2)}ms\n`;
                output += `  Results: ${bruteForceResults.length}\n\n`;

                const speedup = (time2 / time1).toFixed(1);
                output += `<span class="success">‚ö° Speedup: ${speedup}x faster</span>`;

                results.innerHTML = output;
            } catch (error) {
                results.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                console.error(error);
            }
        };

        window.runPerformanceTests = async function() {
            const results = document.getElementById('perfResults');
            results.innerHTML = '<span class="info">Running performance tests...</span>';

            try {
                const tests = [];

                // Test 1: Embedding generation speed
                const text = "This is a test sentence for embedding generation.";
                const start1 = performance.now();
                await embeddingService.generateEmbedding(text);
                const embTime = performance.now() - start1;
                tests.push(`Embedding Generation: ${embTime.toFixed(2)}ms`);

                // Test 2: Semantic chunking
                const longText = "Lorem ipsum dolor sit amet. ".repeat(50);
                const start2 = performance.now();
                const chunks = await embeddingService.chunkText(longText);
                const chunkTime = performance.now() - start2;
                tests.push(`Text Chunking (${chunks.length} chunks): ${chunkTime.toFixed(2)}ms`);

                // Test 3: Vector search accuracy
                const query = "machine learning algorithms";
                const queryEmb = await embeddingService.generateEmbedding(query);
                const results3 = await dbService.vectorSearch(queryEmb, { limit: 5 });
                const avgScore = results3.reduce((sum, r) => sum + r.score, 0) / results3.length;
                tests.push(`Search Accuracy (avg score): ${avgScore.toFixed(4)}`);

                // Test 4: Memory usage
                const memoryInfo = performance.memory ?
                    `${(performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2)}MB` :
                    'N/A';
                tests.push(`Memory Usage: ${memoryInfo}`);

                // Test 5: Index statistics
                const stats = await dbService.getStorageStats();
                tests.push(`Documents: ${stats.documents || 0}, Embeddings: ${stats.embeddings || 0}`);

                let output = '<span class="success">‚úÖ Performance Tests Complete</span>\n\n';
                tests.forEach((test, idx) => {
                    output += `${idx + 1}. ${test}\n`;
                });

                results.innerHTML = output;
            } catch (error) {
                results.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Initialize on page load
        window.addEventListener('load', async () => {
            try {
                await dbService.initialize();
                await embeddingService.initialize();
                console.log('RAG system initialized');
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        });
    </script>
</body>
</html>