<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Function Calling Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h2 { color: #00d4ff; margin-top: 0; }
        button {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        button:hover { background: #00a8cc; }
        button:disabled { background: #555; color: #999; cursor: not-allowed; }
        .log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .status.ready { background: #065f46; }
        .status.loading { background: #854d0e; }
        .query-input {
            width: 100%;
            padding: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Manual Function Calling Test</h1>
    
    <div class="section">
        <h2>Status</h2>
        <div id="status" class="status loading">Initializing...</div>
    </div>

    <div class="section">
        <h2>Test Query</h2>
        <input type="text" id="queryInput" class="query-input" 
               placeholder="E.g., What's the weather in San Francisco?" 
               value="What's the weather in San Francisco?">
        <button id="testBtn" disabled>Test Manual Function Call</button>
        <button id="clearBtn">Clear</button>
    </div>

    <div class="section">
        <h2>Response</h2>
        <div id="response" class="log">Waiting for test...</div>
    </div>

    <div class="section">
        <h2>Debug Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        const WEBLLM_URL = "https://unpkg.com/@mlc-ai/web-llm@0.2.79?module";
        let engine = null;
        let functionCallingService = null;
        
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }
        
        async function initialize() {
            try {
                // Load function calling service
                log('Loading function calling service...');
                const module = await import('./src/lib/function-calling-service.js');
                functionCallingService = module.default;
                
                // Check WebGPU
                if (!navigator.gpu) {
                    throw new Error('WebGPU not supported');
                }
                
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('No GPU adapter found');
                }
                
                log('WebGPU supported ✓');
                
                // Load WebLLM
                log('Loading WebLLM...');
                const webllm = await import(WEBLLM_URL);
                
                // Load Hermes model
                const modelId = 'Hermes-3-Llama-3.1-8B-q4f16_1-MLC';
                log(`Loading model: ${modelId}`);
                
                engine = await webllm.CreateMLCEngine(modelId, {
                    initProgressCallback: (report) => {
                        log(report.text || "Loading...");
                    },
                    appConfig: webllm.prebuiltAppConfig,
                    logLevel: "INFO",
                    useWebWorker: false
                });
                
                log('Model loaded successfully!');
                document.getElementById('status').textContent = 'Ready';
                document.getElementById('status').className = 'status ready';
                document.getElementById('testBtn').disabled = false;
                
            } catch (error) {
                log(`Error: ${error.message}`);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        }
        
        async function testManualFunctionCall() {
            const query = document.getElementById('queryInput').value;
            if (!query || !engine) return;
            
            log(`\n=== Testing: "${query}" ===`);
            document.getElementById('response').textContent = 'Processing...';
            
            // Get manual function calling prompt
            const manualPrompt = functionCallingService.getManualFunctionCallingPrompt();
            
            const messages = [
                { 
                    role: 'system', 
                    content: `You are a helpful assistant.\n\n${manualPrompt}` 
                },
                { role: 'user', content: query }
            ];
            
            log('Sending request WITHOUT tools parameter...');
            log('System prompt includes manual function calling instructions');
            
            try {
                // First request - expect [SEARCH: query] response
                const request = {
                    messages,
                    temperature: 0.7,
                    max_tokens: 100,
                    stream: false
                };
                
                log('Waiting for model response...');
                const response = await engine.chat.completions.create(request);
                const content = response.choices[0].message.content;
                
                log(`Model response: ${content}`);
                document.getElementById('response').textContent = content;
                
                // Check if model outputted manual function call
                const manualCall = functionCallingService.detectManualFunctionCall(content);
                
                if (manualCall.detected) {
                    log(`✓ Manual function call detected: ${manualCall.function}("${manualCall.query}")`);
                    
                    // Execute the search
                    log('Executing web search...');
                    const searchResult = await functionCallingService.executeTextFunctionCall(manualCall);
                    
                    if (searchResult) {
                        log('Search completed, sending results back to model...');
                        
                        // Continue conversation with search results
                        const continueMessages = [
                            ...messages,
                            { role: 'assistant', content: content },
                            { 
                                role: 'system', 
                                content: `Search results:\n${searchResult}\n\nNow provide a helpful response based on these search results.`
                            }
                        ];
                        
                        const finalResponse = await engine.chat.completions.create({
                            messages: continueMessages,
                            temperature: 0.7,
                            max_tokens: 300,
                            stream: false
                        });
                        
                        const finalContent = finalResponse.choices[0].message.content;
                        log('Final response received');
                        document.getElementById('response').textContent = 
                            `Initial: ${content}\n\n` +
                            `Search Results: [Executed]\n\n` +
                            `Final Response: ${finalContent}`;
                    }
                } else {
                    log('✗ No manual function call detected in response');
                    log('Model may have responded directly without using search');
                }
                
            } catch (error) {
                log(`Error: ${error.message}`);
                document.getElementById('response').textContent = `Error: ${error.message}`;
            }
        }
        
        // Initialize on load
        initialize();
        
        // Event listeners
        document.getElementById('testBtn').addEventListener('click', testManualFunctionCall);
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('response').textContent = 'Waiting for test...';
            document.getElementById('log').textContent = '';
        });
        
        document.getElementById('queryInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('testBtn').disabled) {
                testManualFunctionCall();
            }
        });
    </script>
</body>
</html>