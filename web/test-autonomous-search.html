<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Autonomous Web Search</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h2 { color: #00d4ff; margin-top: 0; }
        button {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        button:hover { background: #00a8cc; }
        button:disabled { background: #555; color: #999; cursor: not-allowed; }
        .log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .status.ready { background: #065f46; }
        .status.loading { background: #854d0e; }
        .test-query {
            padding: 10px;
            margin: 5px;
            background: #333;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-query:hover { background: #444; }
    </style>
</head>
<body>
    <h1>Test Autonomous Web Search</h1>
    
    <div class="section">
        <h2>Status</h2>
        <div id="status" class="status loading">Initializing...</div>
    </div>

    <div class="section">
        <h2>Test Queries (Click to Test)</h2>
        <div class="test-query" data-query="What's the weather in Santiago, Chile?">
            üå§Ô∏è What's the weather in Santiago, Chile? (Should trigger search)
        </div>
        <div class="test-query" data-query="Who is the current president of France?">
            üó≥Ô∏è Who is the current president of France? (Should trigger search)
        </div>
        <div class="test-query" data-query="How do I install a self-hosted Zulip server?">
            üîß How do I install a self-hosted Zulip server? (Should trigger search)
        </div>
        <div class="test-query" data-query="What is Python programming language?">
            üêç What is Python programming language? (Should NOT trigger search - general knowledge)
        </div>
        <div class="test-query" data-query="Explain how recursion works">
            üîÑ Explain how recursion works (Should NOT trigger search - general knowledge)
        </div>
        <div class="test-query" data-query="What are the latest AI developments this week?">
            ü§ñ What are the latest AI developments this week? (Should trigger search)
        </div>
    </div>

    <div class="section">
        <h2>Response</h2>
        <div id="response" class="log">Click a test query to see the response...</div>
    </div>

    <div class="section">
        <h2>Debug Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        const WEBLLM_URL = "https://unpkg.com/@mlc-ai/web-llm@0.2.79?module";
        let engine = null;
        let functionCallingService = null;
        
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }
        
        async function initialize() {
            try {
                // Load function calling service
                log('Loading function calling service...');
                const module = await import('./src/lib/function-calling-service.js');
                functionCallingService = module.default;
                
                // Check WebGPU
                if (!navigator.gpu) {
                    throw new Error('WebGPU not supported');
                }
                
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('No GPU adapter found');
                }
                
                log('WebGPU supported ‚úì');
                
                // Load WebLLM
                log('Loading WebLLM...');
                const webllm = await import(WEBLLM_URL);
                
                // Load Hermes model
                const modelId = 'Hermes-3-Llama-3.1-8B-q4f16_1-MLC';
                log(`Loading model: ${modelId}`);
                
                engine = await webllm.CreateMLCEngine(modelId, {
                    initProgressCallback: (report) => {
                        log(report.text || "Loading...");
                    },
                    appConfig: webllm.prebuiltAppConfig,
                    logLevel: "INFO",
                    useWebWorker: false
                });
                
                log('Model loaded successfully!');
                document.getElementById('status').textContent = 'Ready - Click a query to test';
                document.getElementById('status').className = 'status ready';
                
            } catch (error) {
                log(`Error: ${error.message}`);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        }
        
        async function testQuery(query) {
            if (!engine) return;
            
            log(`\n=== Testing: "${query}" ===`);
            document.getElementById('response').textContent = 'Processing...';
            
            // Get the manual function calling prompt
            const manualPrompt = functionCallingService.getManualFunctionCallingPrompt();
            
            const messages = [
                { 
                    role: 'system', 
                    content: `You are a helpful assistant.\n\n${manualPrompt}` 
                },
                { role: 'user', content: query }
            ];
            
            log('Sending query to model...');
            
            try {
                const request = {
                    messages,
                    temperature: 0.7,
                    max_tokens: 150,
                    stream: false
                };
                
                const response = await engine.chat.completions.create(request);
                const content = response.choices[0].message.content;
                
                log(`Model response: ${content}`);
                
                // Check if model decided to search
                const searchPattern = /\[SEARCH:/i;
                const didSearch = searchPattern.test(content);
                
                if (didSearch) {
                    log('‚úÖ Model autonomously decided to search!');
                    document.getElementById('response').textContent = 
                        `‚úÖ SEARCH TRIGGERED\n\nModel Output:\n${content}\n\n` +
                        `The model correctly identified this query needs web search.`;
                } else {
                    log('‚ÑπÔ∏è Model decided not to search (using general knowledge)');
                    document.getElementById('response').textContent = 
                        `‚ÑπÔ∏è NO SEARCH (General Knowledge)\n\nModel Output:\n${content}\n\n` +
                        `The model decided to answer from its training data.`;
                }
                
            } catch (error) {
                log(`Error: ${error.message}`);
                document.getElementById('response').textContent = `Error: ${error.message}`;
            }
        }
        
        // Initialize on load
        initialize();
        
        // Add click handlers to test queries
        document.querySelectorAll('.test-query').forEach(el => {
            el.addEventListener('click', () => {
                const query = el.getAttribute('data-query');
                testQuery(query);
            });
        });
    </script>
</body>
</html>